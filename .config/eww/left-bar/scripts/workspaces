#!/bin/python

import datetime
import subprocess
import json

workspaces = subprocess.run(
    ["wmctrl", "-d"],
    stdout=subprocess.PIPE,
    stderr=subprocess.STDOUT,
).stdout.decode('utf8').strip()

windows = (
    subprocess.run(
        ["wmctrl", "-lx"],
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
    )
    .stdout.decode()
    .strip()
)

active_windows = [int(w[10:13]) for w in windows.split("\n") if w]
workspace_labels = [w.split(' ')[-1] for w in workspaces.split("\n")]
current_workspace = int([w.split(' ')[0] for w in workspaces.split("\n") if "*" in w][0])

workspaces_by_monitor = {}
for index, label in enumerate(workspace_labels):
    monitor = index // 10
    if monitor not in workspaces_by_monitor:
        workspaces_by_monitor[monitor] = []

    class_name = "current" if index == current_workspace else "active" if index in active_windows else "empty"
    workspace = {
        "class": class_name,
        "index": index,
        "label": label
    }

    if class_name == "current":
        open_windows_info = [w for w in windows.split("\n") if f" {index} " in w]
        if len(open_windows_info) > 0:
            open_windows = [
                {
                    "id": w.split(" ")[0],
                    "name": [s for s in w.split(" ") if s != ""][2]
                    .split(".")
                    .pop(),  # handle possible double spaces that fuck up the split on ' '
                }
                for w in open_windows_info
            ]
            workspaces_by_monitor["open"] = open_windows
            workspaces_by_monitor["open_in_monitor"] = monitor
        else:
            workspaces_by_monitor["open"] = []
            workspaces_by_monitor["open_in_monitor"] = -1


    workspaces_by_monitor[monitor].append(workspace)

workspaces_by_monitor['time'] = datetime.datetime.now().strftime('%S')

print(json.dumps(workspaces_by_monitor, ensure_ascii=False))
